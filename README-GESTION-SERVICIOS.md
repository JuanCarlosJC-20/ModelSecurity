# üîß ModelSecurity - Gesti√≥n y Reinicio de Servicios

Gu√≠a completa para **gestionar**, **reiniciar** y **mantener** tu aplicaci√≥n ModelSecurity despu√©s del despliegue inicial.

## üìã Informaci√≥n Importante

‚ö†Ô∏è **Al reiniciar el contenedor, los servicios NO se inician autom√°ticamente**

Cuando detienes y vuelves a iniciar el contenedor Docker, necesitas **reiniciar manualmente** todos los servicios:
- MySQL
- PostgreSQL  
- Nginx
- API .NET

---

## üîÑ Gesti√≥n B√°sica del Contenedor

### **Detener Contenedor**
```bash
# Desde Windows (CMD o PowerShell)
docker stop modelo-security-app
```

### **Iniciar Contenedor**
```bash
# Desde Windows  
docker start modelo-security-app
```

### **Ver Estado del Contenedor**
```bash
# Ver todos los contenedores
docker ps -a

# Ver solo contenedores activos
docker ps
```

### **Entrar al Contenedor**
```bash
# Acceso interactivo
docker exec -it modelo-security-app bash
```

---

## üöÄ Reinicio de Servicios (M√©todo R√°pido)

### **Opci√≥n 1: Script Autom√°tico (Recomendado)**

```bash
# Desde Windows - Reinicio completo en un comando
docker exec -it modelo-security-app /opt/start-services.sh
```

### **Opci√≥n 2: Paso a Paso Manual**

```bash
# 1. Entrar al contenedor
docker exec -it modelo-security-app bash

# 2. Dentro del contenedor, ejecutar:
/opt/start-services.sh
```

### **Si el script no existe, crearlo:**

```bash
# Entrar al contenedor
docker exec -it modelo-security-app bash

# Crear script de inicio
cat > /opt/start-services.sh << 'EOF'
#!/bin/bash

echo "üöÄ Iniciando servicios ModelSecurity..."

# Iniciar MySQL
service mysql start
echo "‚úÖ MySQL iniciado en puerto 3306"

# Iniciar PostgreSQL  
service postgresql start
echo "‚úÖ PostgreSQL iniciado en puerto 5432"

# Iniciar Nginx
service nginx start
echo "‚úÖ Nginx iniciado en puerto 3000"

# Esperar que las bases de datos est√©n listas
sleep 5

# Iniciar API
cd /opt/modelsecurity-api
export ASPNETCORE_ENVIRONMENT=Production
export ASPNETCORE_URLS=http://0.0.0.0:5000
nohup dotnet Web.dll > /var/log/api.log 2>&1 &
echo "‚úÖ API iniciada en puerto 5000"

echo ""
echo "üåê Aplicaci√≥n disponible en:"
echo "   Frontend: http://localhost:3000"
echo "   API: http://localhost:5000"
echo "   Frontend Externo: http://192.168.101.14:3000"
echo "   API Externa: http://192.168.101.14:5000"
echo ""
echo "üìä Para ver logs de la API: tail -f /var/log/api.log"
EOF

# Dar permisos de ejecuci√≥n
chmod +x /opt/start-services.sh

# Ejecutar el script
/opt/start-services.sh
```

---

## üîç Verificaci√≥n de Estado de Servicios

### **Verificar Todos los Servicios**
```bash
# Entrar al contenedor
docker exec -it modelo-security-app bash

# Ver procesos activos
ps aux | grep -E "(nginx|mysql|postgres|dotnet)"

# Ver puertos en uso
netstat -tulpn | grep -E "(3000|5000|3306|5432)"
```

### **Verificar Servicios Individualmente**

```bash
# Estado de MySQL
service mysql status

# Estado de PostgreSQL
service postgresql status

# Estado de Nginx
service nginx status

# Ver proceso de la API
ps aux | grep dotnet
```

### **Verificar Conectividad**

```bash
# Probar MySQL
mysql -u root -p1234567 -e "SELECT 1;"

# Probar PostgreSQL
su - postgres -c "psql -d ModelSecurity -c 'SELECT 1;'"

# Probar API (desde otro terminal)
curl http://localhost:5000
curl http://192.168.101.14:5000
```

---

## üõ†Ô∏è Gesti√≥n de Servicios Individuales

### **MySQL**
```bash
# Iniciar
service mysql start

# Detener  
service mysql stop

# Reiniciar
service mysql restart

# Ver estado
service mysql status
```

### **PostgreSQL**
```bash
# Iniciar
service postgresql start

# Detener
service postgresql stop

# Reiniciar  
service postgresql restart

# Ver estado
service postgresql status
```

### **Nginx**
```bash
# Iniciar
service nginx start

# Detener
service nginx stop

# Reiniciar
service nginx restart

# Ver estado
service nginx status

# Verificar configuraci√≥n
nginx -t
```

### **API (.NET)**
```bash
# Detener API actual
pkill dotnet

# Iniciar API
cd /opt/modelsecurity-api
export ASPNETCORE_ENVIRONMENT=Production
export ASPNETCORE_URLS=http://0.0.0.0:5000
nohup dotnet Web.dll > /var/log/api.log 2>&1 &

# Ver logs en tiempo real
tail -f /var/log/api.log
```

---

## üìä Monitoreo y Logs

### **Ver Logs de la API**
```bash
# Ver logs en tiempo real
docker exec -it modelo-security-app tail -f /var/log/api.log

# Ver √∫ltimas 50 l√≠neas
docker exec -it modelo-security-app tail -n 50 /var/log/api.log

# Buscar errores
docker exec -it modelo-security-app grep -i error /var/log/api.log
```

### **Ver Logs de Nginx**
```bash
# Logs de acceso
docker exec -it modelo-security-app tail -f /var/log/nginx/access.log

# Logs de errores
docker exec -it modelo-security-app tail -f /var/log/nginx/error.log
```

### **Ver Logs de MySQL**
```bash
# Log general (ubicaci√≥n puede variar)
docker exec -it modelo-security-app tail -f /var/log/mysql/error.log
```

### **Ver Logs de PostgreSQL**
```bash
# Logs de PostgreSQL
docker exec -it modelo-security-app tail -f /var/log/postgresql/postgresql-*-main.log
```

---

## üö® Soluci√≥n de Problemas Comunes

### **"El contenedor no inicia"**
```bash
# Ver logs del contenedor
docker logs modelo-security-app

# Iniciar en modo interactivo para diagnosticar
docker run -it --rm -p 3000:3000 -p 5000:5000 ubuntu:latest bash
```

### **"Los servicios no inician"**
```bash
# Verificar espacio en disco
df -h

# Verificar memoria
free -h

# Verificar permisos
ls -la /opt/start-services.sh
chmod +x /opt/start-services.sh
```

### **"MySQL no conecta"**
```bash
# Verificar proceso
ps aux | grep mysql

# Iniciar manualmente
service mysql start

# Ver logs de error
tail -f /var/log/mysql/error.log

# Reiniciar servicio
service mysql restart
```

### **"PostgreSQL no conecta"**  
```bash
# Verificar proceso
ps aux | grep postgres

# Iniciar manualmente
service postgresql start

# Verificar configuraci√≥n
su - postgres -c "psql -c '\\l'"
```

### **"Nginx no sirve el frontend"**
```bash
# Verificar configuraci√≥n
nginx -t

# Ver archivos del frontend
ls -la /var/www/html/

# Verificar permisos
chmod -R 755 /var/www/html/

# Reiniciar nginx
service nginx restart
```

### **"API devuelve Error 500"**
```bash
# Ver logs detallados
tail -f /var/log/api.log

# Verificar configuraci√≥n
cat /opt/modelsecurity-api/appsettings.Production.json

# Verificar bases de datos
mysql -u root -p1234567 -e "SELECT 1;"
su - postgres -c "psql -d ModelSecurity -c 'SELECT 1;'"

# Reiniciar API
pkill dotnet
cd /opt/modelsecurity-api && nohup dotnet Web.dll > /var/log/api.log 2>&1 &
```

---

## ‚ö° Scripts de Automatizaci√≥n

### **Script de Reinicio Completo**
```bash
# Crear script avanzado
cat > /opt/full-restart.sh << 'EOF'
#!/bin/bash
echo "üîÑ Reinicio completo de ModelSecurity..."

# Detener servicios
echo "üõë Deteniendo servicios..."
pkill dotnet 2>/dev/null
service nginx stop 2>/dev/null
service postgresql stop 2>/dev/null  
service mysql stop 2>/dev/null

sleep 3

# Iniciar servicios
echo "üöÄ Iniciando servicios..."
service mysql start
service postgresql start
service nginx start

# Esperar que las bases de datos est√©n listas
sleep 5

# Iniciar API
cd /opt/modelsecurity-api
export ASPNETCORE_ENVIRONMENT=Production
export ASPNETCORE_URLS=http://0.0.0.0:5000
nohup dotnet Web.dll > /var/log/api.log 2>&1 &

echo "‚úÖ Reinicio completado"
echo "üåê Frontend: http://localhost:3000 | http://192.168.101.14:3000"
echo "üîß API: http://localhost:5000 | http://192.168.101.14:5000"
EOF

chmod +x /opt/full-restart.sh
```

### **Script de Verificaci√≥n de Estado**
```bash
# Crear script de diagn√≥stico
cat > /opt/check-status.sh << 'EOF'
#!/bin/bash
echo "üìä Estado de ModelSecurity"
echo "========================="

# Verificar servicios
echo "üîç Servicios activos:"
ps aux | grep -E "(nginx|mysql|postgres|dotnet)" | grep -v grep

echo ""
echo "üåê Puertos en uso:"
netstat -tulpn | grep -E "(3000|5000|3306|5432)"

echo ""
echo "üíæ Conectividad de bases de datos:"
mysql -u root -p1234567 -e "SELECT 'MySQL OK' as Status;" 2>/dev/null || echo "‚ùå MySQL desconectado"
su - postgres -c "psql -d ModelSecurity -c \"SELECT 'PostgreSQL OK' as Status;\"" 2>/dev/null || echo "‚ùå PostgreSQL desconectado"

echo ""
echo "üìÅ Archivos del frontend:"
ls -la /var/www/html/index.html 2>/dev/null && echo "‚úÖ Frontend OK" || echo "‚ùå Frontend faltante"

echo ""
echo "üîß API:"
curl -s http://localhost:5000 >/dev/null && echo "‚úÖ API respondiendo" || echo "‚ùå API no responde"
EOF

chmod +x /opt/check-status.sh
```

### **Usar los Scripts**
```bash
# Desde Windows
docker exec -it modelo-security-app /opt/full-restart.sh
docker exec -it modelo-security-app /opt/check-status.sh
```

---

## üîÑ Inicio Autom√°tico (Opcional)

### **Configurar Inicio Autom√°tico al Entrar al Contenedor**
```bash
# Agregar script al perfil de bash
echo '# Auto-start ModelSecurity services' >> /root/.bashrc
echo 'if [ ! -f /tmp/services-started ]; then' >> /root/.bashrc  
echo '  echo "üöÄ Iniciando servicios ModelSecurity..."' >> /root/.bashrc
echo '  /opt/start-services.sh' >> /root/.bashrc
echo '  touch /tmp/services-started' >> /root/.bashrc
echo 'fi' >> /root/.bashrc
```

### **Contenedor con Pol√≠tica de Reinicio Autom√°tico**
```bash
# Detener y eliminar contenedor actual
docker stop modelo-security-app
docker rm modelo-security-app

# Crear nuevo contenedor con restart autom√°tico
docker run -it -d --name modelo-security-app --restart=unless-stopped -p 3000:3000 -p 5000:5000 ubuntu:latest bash

# Luego seguir el proceso de instalaci√≥n inicial
```

---

## üìã Comandos de Referencia R√°pida

### **Desde Windows (Un Solo Comando)**
```bash
# Reiniciar contenedor y servicios
docker start modelo-security-app && docker exec -it modelo-security-app /opt/start-services.sh

# Ver estado completo  
docker exec -it modelo-security-app /opt/check-status.sh

# Ver logs de API
docker exec -it modelo-security-app tail -f /var/log/api.log

# Entrar al contenedor
docker exec -it modelo-security-app bash
```

### **Dentro del Contenedor**
```bash
# Iniciar todos los servicios
/opt/start-services.sh

# Reiniciar completamente
/opt/full-restart.sh

# Verificar estado
/opt/check-status.sh

# Ver logs de API
tail -f /var/log/api.log
```

---

## ‚úÖ Verificaci√≥n Final

Tu aplicaci√≥n est√° correctamente funcionando si:

1. ‚úÖ **Contenedor iniciado**: `docker ps` muestra `modelo-security-app`
2. ‚úÖ **Servicios corriendo**: `/opt/check-status.sh` muestra todos los servicios activos
3. ‚úÖ **Frontend accesible**: http://localhost:3000 y http://192.168.101.14:3000
4. ‚úÖ **API accesible**: http://localhost:5000 y http://192.168.101.14:5000
5. ‚úÖ **Bases de datos conectadas**: MySQL y PostgreSQL responden
6. ‚úÖ **Sin errores en logs**: `tail -f /var/log/api.log` no muestra errores

---

## üéØ Rutina de Reinicio T√≠pica

**Cada vez que reinicies el contenedor:**

1. `docker start modelo-security-app`
2. `docker exec -it modelo-security-app /opt/start-services.sh`
3. Verificar en navegador: http://localhost:3000

**¬°Listo! Tu aplicaci√≥n estar√° funcionando nuevamente.**

---

**üîß ¬°Tu aplicaci√≥n ModelSecurity est√° completamente gestionada y lista para usar!**

*Gu√≠a completa para reinicio, monitoreo y mantenimiento de servicios*